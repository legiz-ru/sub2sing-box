<!DOCTYPE html>
<html lang="zh-CN" class="mdui-theme-auto">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sub2sing-box</title>
  <link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
  <script src="https://unpkg.com/mdui@2/mdui.global.js"></script>
  <style>
    h3 {
      margin-top: 0;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      background-color: rgb(var(--mdui-color-surface-container));
    }
    .section > * {
      margin-bottom: 10px;
    }
    .mdui-container {
      border-radius: 10px;
      max-width: 1200px;
      margin: 30px auto;
    }
    .header-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    /* Fonts for different languages */
    html[lang="zh-CN"] {
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    html[lang="en"] {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    html[lang="ru"] {
      font-family: "Arial", "Helvetica", sans-serif;
    }
  </style>
</head>

<body>
  <div class="mdui-container">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <h2>
        <a href="https://github.com/nitezs/sub2sing-box" target="_blank">sub2sing-box</a>
      </h2>
      <div class="header-controls">
        <!-- Language switcher -->
        <mdui-dropdown trigger="hover">
          <mdui-icon slot="trigger" name="language"></mdui-icon>
          <mdui-menu id="language" selects="single" value="zh-CN">
            <mdui-menu-item value="zh-CN">中文</mdui-menu-item>
            <mdui-menu-item value="en">English</mdui-menu-item>
            <mdui-menu-item value="ru">Русский</mdui-menu-item>
          </mdui-menu>
        </mdui-dropdown>
        <!-- Theme switcher -->
        <mdui-dropdown trigger="hover">
          <mdui-icon slot="trigger" name="dark_mode"></mdui-icon>
          <mdui-menu id="theme" selects="single" value="dark">
            <mdui-menu-item value="light" data-i18n="theme-light">亮色</mdui-menu-item>
            <mdui-menu-item value="dark" data-i18n="theme-dark">暗色</mdui-menu-item>
            <mdui-divider></mdui-divider>
            <mdui-menu-item value="auto" data-i18n="theme-auto">跟随系统</mdui-menu-item>
          </mdui-menu>
        </mdui-dropdown>
      </div>
    </div>

    <!-- Template Section -->
    <div class="section">
      <h3>
        <a href="https://github.com/nitezs/sub2sing-box/tree/master/templates" data-i18n="template">模板</a>
      </h3>
      <mdui-text-field data-i18n="template" label="模板" type="text" id="template" name="template"
        value="https://raw.githubusercontent.com/nitezs/sub2sing-box/refs/heads/master/templates/example-windows.json">
      </mdui-text-field>
    </div>

    <div id="form">
      <!-- Nodes Section -->
      <div class="section">
        <h3 data-i18n="nodes">节点</h3>
        <div>
          <mdui-text-field data-i18n="subscription-link" label="订阅链接" autosize min-rows="3" max-rows="5" 
            id="subscription" name="subscription" placeholder="一行一个">
          </mdui-text-field>
        </div>
        <div>
          <mdui-text-field data-i18n="proxy-link" label="节点分享链接" autosize min-rows="3" max-rows="5" 
            id="proxy" name="proxy" placeholder="一行一个">
          </mdui-text-field>
        </div>
        <div>
          <mdui-text-field data-i18n="delete-node" label="删除节点" type="text" id="delete" name="delete" 
            placeholder="支持正则表达式">
          </mdui-text-field>
        </div>
        <div>
          <mdui-list id="list">
            <mdui-list-item>
              <span data-i18n="rename-node">重命名节点</span>
              <mdui-button slot="end-icon" type="button" onclick="addRenameField()">+</mdui-button>
            </mdui-list-item>
          </mdui-list>
          <div id="renameContainer"></div>
        </div>
      </div>

      <!-- Policy Group Section -->
      <div class="section">
        <h3 data-i18n="policy-group">策略组</h3>
        <div>
          <mdui-text-field data-i18n="type" label="类型" type="text" id="group-type" name="group-type" 
            value="selector">
          </mdui-text-field>
        </div>
        <div>
          <mdui-select data-i18n="sort-by" label="排序依据" name="sort" id="sort" value="tag">
            <mdui-menu-item value="tag" selected data-i18n="node-name">节点名</mdui-menu-item>
            <mdui-menu-item value="num" data-i18n="node-count">节点数量</mdui-menu-item>
          </mdui-select>
        </div>
        <div>
          <mdui-select data-i18n="sort-order" label="排序方式" name="sort-type" id="sort-type" value="asc">
            <mdui-menu-item value="asc" selected data-i18n="ascending">升序</mdui-menu-item>
            <mdui-menu-item value="desc" data-i18n="descending">降序</mdui-menu-item>
          </mdui-select>
        </div>
      </div>

      <!-- Result Section -->
      <div class="section">
        <mdui-text-field data-i18n="generate-link" label="生成链接" autosize min-rows="2" max-rows="5" 
          id="output" name="output">
        </mdui-text-field>
        <!-- Button to open the custom profile import link -->
        <mdui-button color="primary" onclick="openProfileLink()">
          <span data-i18n="import-profile">Import Profile</span>
        </mdui-button>
      </div>
    </div>
  </div>

  <script>
    // Translation object
    const translations = {
      "zh-CN": {
        "template": "模板",
        "nodes": "节点",
        "subscription-link": "订阅链接",
        "proxy-link": "节点分享链接",
        "delete-node": "删除节点",
        "rename-node": "重命名节点",
        "policy-group": "策略组",
        "type": "类型",
        "sort-by": "排序依据",
        "node-name": "节点名",
        "node-count": "节点数量",
        "sort-order": "排序方式",
        "ascending": "升序",
        "descending": "降序",
        "generate-link": "生成链接",
        "theme-light": "亮色",
        "theme-dark": "暗色",
        "theme-auto": "跟随系统",
        "import-profile": "导入配置"
      },
      "en": {
        "template": "Template",
        "nodes": "Nodes",
        "subscription-link": "Subscription Link",
        "proxy-link": "Node Share Link",
        "delete-node": "Delete Node",
        "rename-node": "Rename Node",
        "policy-group": "Policy Group",
        "type": "Type",
        "sort-by": "Sort By",
        "node-name": "Node Name",
        "node-count": "Node Count",
        "sort-order": "Sort Order",
        "ascending": "Ascending",
        "descending": "Descending",
        "generate-link": "Generate Link",
        "theme-light": "Light",
        "theme-dark": "Dark",
        "theme-auto": "Auto",
        "import-profile": "Import Profile"
      },
      "ru": {
        "template": "Шаблон",
        "nodes": "Узлы",
        "subscription-link": "Ссылка подписки",
        "proxy-link": "Ссылка на узел",
        "delete-node": "Удалить узел",
        "rename-node": "Переименовать узел",
        "policy-group": "Группа политик",
        "type": "Тип",
        "sort-by": "Сортировать по",
        "node-name": "Имя узла",
        "node-count": "Количество узлов",
        "sort-order": "Порядок сортировки",
        "ascending": "По возрастанию",
        "descending": "По убыванию",
        "generate-link": "Создать ссылку",
        "theme-light": "Светлая",
        "theme-dark": "Темная",
        "theme-auto": "Системная",
        "import-profile": "Импортировать профиль"
      }
    };

    // Initialize after DOM fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      init();
    });

    function init() {
      setupLanguage();
      setupTheme();
      listenInput();
      generateLink(); // Generate initial link if default values exist
    }

    // Function to set up language
    function setupLanguage() {
      const languageMenu = document.getElementById('language');
      if (languageMenu) {
        const savedLang = localStorage.getItem('language') || 'zh-CN';
        languageMenu.value = savedLang;
        changeLanguage(savedLang);

        languageMenu.addEventListener('change', function() {
          changeLanguage(languageMenu.value);
        });
      }
    }

    // Function to change language and translate elements with data-i18n
    function changeLanguage(lang) {
      localStorage.setItem('language', lang);
      document.documentElement.setAttribute('lang', lang);

      // Translate elements with data-i18n attribute
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = translations[lang][key];
        if (translation) {
          // For special elements like mdui-text-field or mdui-select, change the label attribute
          if (element.tagName.toLowerCase() === 'mdui-text-field' ||
              element.tagName.toLowerCase() === 'mdui-select') {
            element.setAttribute('label', translation);
          } else {
            element.textContent = translation;
          }
        }
      });

      // Update placeholders for mdui-text-field elements if data-i18n-placeholder is set
      document.querySelectorAll('mdui-text-field').forEach(element => {
        if (element.hasAttribute('placeholder')) {
          const key = element.getAttribute('data-i18n-placeholder');
          if (key && translations[lang][key]) {
            element.setAttribute('placeholder', translations[lang][key]);
          }
        }
      });
    }

    // Function to set up theme based on saved preference
    function setupTheme() {
      const themeMenu = document.getElementById('theme');
      const savedTheme = localStorage.getItem("theme") || "auto";
      document.documentElement.className = "mdui-theme-" + savedTheme;
      themeMenu.value = savedTheme;

      themeMenu.addEventListener("change", function() {
        const newTheme = themeMenu.value;
        document.documentElement.className = "mdui-theme-" + newTheme;
        localStorage.setItem("theme", newTheme);
      });
    }

    // Function to add event listeners for input elements to regenerate the output link
    function listenInput() {
      const inputs = document.querySelectorAll("mdui-text-field, mdui-select, mdui-checkbox");
      inputs.forEach(input => {
        input.addEventListener("input", generateLink);
        input.addEventListener("change", generateLink);
      });
    }

    // Function to remove event listeners from dynamic elements
    function cleanListeners() {
      const inputs = document.querySelectorAll("#form input, #form textarea");
      inputs.forEach(input => {
        input.removeEventListener("input", generateLink);
      });
      const selects = document.querySelectorAll("#form select");
      selects.forEach(select => {
        select.removeEventListener("change", generateLink);
      });
    }

    // Function to add rename fields dynamically
    function addRenameField() {
      cleanListeners();
      const container = document.getElementById("list");
      const currentLang = localStorage.getItem('language') || 'zh-CN';
      const fieldHTML = `
        <mdui-list-item class="rename-group">
          <mdui-text-field slot="icon" type="text" name="rename_from[]"
            data-i18n-placeholder="delete-node"
            label="${translations[currentLang]['delete-node']}"
            data-i18n="rename-node">
          </mdui-text-field>
          <mdui-text-field type="text" name="rename_to[]"
            label="${translations[currentLang]['rename-node']}"
            data-i18n="rename-node">
          </mdui-text-field>
          <mdui-button slot="end-icon" type="button" onclick="removeThisField(this)">-</mdui-button>
        </mdui-list-item>`;
      container.insertAdjacentHTML("beforeend", fieldHTML);
      listenInput();
    }

    // Function to remove a specific rename field
    function removeThisField(button) {
      cleanListeners();
      button.parentElement.remove();
      generateLink();
      listenInput();
    }

    // Function to generate the output link based on form data
    function generateLink() {
      const subscription = document.getElementById("subscription").value
        .split("\n").filter(i => i.trim());
      const proxy = document.getElementById("proxy").value
        .split("\n").filter(i => i.trim());
      const deleteRule = document.getElementById("delete").value;
      const template = document.getElementById("template").value;
      const renameFrom = Array.from(document.getElementsByName("rename_from[]")).map(input => input.value);
      const renameTo = Array.from(document.getElementsByName("rename_to[]")).map(input => input.value);
      const output = document.getElementById("output");
      const groupType = document.getElementById("group-type").value;
      const sort = document.getElementById("sort").value;
      const sortType = document.getElementById("sort-type").value;

      let rename = {};
      for (let i = 0; i < renameFrom.length; i++) {
        if (renameFrom[i] && renameTo[i]) {
          rename[renameFrom[i]] = renameTo[i];
        }
      }

      const data = {
        subscription,
        proxy,
        delete: deleteRule,
        template,
        rename,
        "group-type": groupType,
        sort,
        "sort-type": sortType
      };

      // Set the output field value to the generated URL with base64 encoded data
      output.value = window.location.origin + "/convert?data=" + encodeBase64(JSON.stringify(data));
    }

    // Function to encode a string in base64 (with URL-friendly replacements)
    function encodeBase64(str) {
      return btoa(
        encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
          return String.fromCharCode("0x" + p1);
        })
      ).replace(/\+/g, "-").replace(/\//g, "_");
    }

    // Function to open the profile import link using the generated output value
    function openProfileLink() {
      const output = document.getElementById("output").value;
      if (output) {
        const profileUrl = "sing-box://import-remote-profile?url=" + encodeURIComponent(output);
        // Open the custom protocol URL
        window.location.href = profileUrl;
      } else {
        alert("Output link is empty");
      }
    }
  </script>
</body>

</html>